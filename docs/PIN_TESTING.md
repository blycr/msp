# PIN 认证功能测试指南

## 功能说明

PIN 认证功能已成功添加到 MSP 项目中。当启用 PIN 认证后，用户在访问应用时会看到一个身份验证对话框，需要输入正确的 PIN 码才能继续使用。

## 测试步骤

### 1. 启用 PIN 认证

编辑 `config.json` 文件（或 `bin/windows/x64/config.json`），设置：

```json
{
  "security": {
    "ipWhitelist": [],
    "ipBlacklist": [],
    "pinEnabled": true,
    "pin": "1999"
  }
}
```

### 2. 启动服务器

```bash
# Windows
.\bin\msp.exe

# 或使用开发脚本
.\scripts\dev.ps1
```

### 3. 访问应用

打开浏览器访问 `http://localhost:8099`

### 4. 预期行为

**启用 PIN 时：**
1. 页面加载后，会立即显示 PIN 认证对话框
2. 对话框标题显示"身份验证"（中文）或"Authentication Required"（英文）
3. 输入框居中显示，字母间距增大，便于输入
4. 输入正确的 PIN（如 `1999`）后点击"提交"
5. 验证成功后，对话框关闭，页面自动刷新并正常加载
6. Cookie 会保存 7 天，期间无需重复输入

**输入错误 PIN 时：**
1. 显示红色错误提示："PIN 码错误，请重试。"
2. 输入框清空，重新聚焦
3. 可以继续尝试

**未启用 PIN 时：**
1. 不显示 PIN 对话框
2. 应用正常加载

## UI 特性

### 设计一致性

PIN 对话框完全遵循现有的设计语言：

- **主题适配**：自动适配亮色/暗色主题
- **颜色变量**：使用 `--md-primary`、`--md-danger` 等主题变量
- **圆角和阴影**：与其他对话框保持一致
- **过渡动画**：200ms 的平滑过渡
- **响应式**：在移动设备上也能正常显示

### 交互体验

- **自动聚焦**：对话框打开后自动聚焦到输入框
- **Enter 提交**：支持按 Enter 键提交
- **加载状态**：提交时按钮显示"验证中..."并禁用
- **错误反馈**：错误信息以红色显示在输入框下方
- **无障碍**：支持键盘导航和屏幕阅读器

### 国际化

支持中英文切换：

**中文：**
- 标题：身份验证
- 说明：请输入 PIN 码以访问此服务。
- 占位符：输入 PIN 码
- 按钮：提交
- 错误：PIN 码错误，请重试。
- 验证中：验证中...

**英文：**
- Title: Authentication Required
- Note: Please enter the PIN code to access this service.
- Placeholder: Enter PIN
- Button: Submit
- Error: Incorrect PIN. Please try again.
- Checking: Verifying...

## 技术实现

### 前端

1. **HTML 结构**（`web/index.html`）
   - 添加 PIN 对话框和背景遮罩
   - 使用现有的 `.dialog` 和 `.dialog__backdrop` 样式

2. **JavaScript 逻辑**（`web/src/app.js`）
   - `checkPinRequired()`: 检查是否需要 PIN
   - `showPinDialog()`: 显示 PIN 对话框
   - `verifyPin()`: 验证 PIN 码
   - `bindPinDialog()`: 绑定事件处理
   - 在 `boot()` 函数中集成 PIN 检查

3. **国际化**
   - 在 `I18N` 对象中添加中英文翻译

### 后端

1. **API 端点**（`/api/pin`）
   - 接受 POST 请求
   - 验证 PIN 码
   - 设置 Cookie（7天有效期）

2. **中间件**
   - IP 过滤在 PIN 验证之前执行
   - PIN 验证豁免 `/api/pin` 端点本身

## 安全注意事项

1. **Cookie 安全**
   - HttpOnly: 防止 XSS 攻击
   - SameSite: Strict 模式
   - 7 天有效期

2. **传输安全**
   - 建议在生产环境使用 HTTPS
   - PIN 通过 POST 请求传输

3. **暴力破解防护**
   - 建议使用较长的 PIN（6-8 位）
   - 可以结合 IP 白名单使用

## 测试场景

### 场景 1：首次访问（启用 PIN）
1. 清除浏览器 Cookie
2. 访问应用
3. 应该看到 PIN 对话框
4. 输入正确 PIN
5. 应该进入应用

### 场景 2：Cookie 有效期内
1. 已经验证过 PIN
2. 关闭浏览器重新打开
3. 访问应用
4. 应该直接进入，不显示 PIN 对话框

### 场景 3：错误 PIN
1. 输入错误的 PIN
2. 应该显示错误提示
3. 输入框清空并重新聚焦
4. 可以继续尝试

### 场景 4：禁用 PIN
1. 设置 `pinEnabled: false`
2. 重启服务器
3. 访问应用
4. 应该直接进入，不显示 PIN 对话框

### 场景 5：移动设备
1. 在手机或平板上访问
2. PIN 对话框应该正确显示
3. 输入框应该触发数字键盘（如果 PIN 是纯数字）
4. 布局应该适配小屏幕

## 已知限制

1. **密码类型**：当前输入框类型为 `password`，会隐藏输入内容
2. **重试限制**：暂无重试次数限制
3. **忘记 PIN**：需要手动编辑配置文件

## 后续改进建议

1. 添加"显示/隐藏密码"切换按钮
2. 添加重试次数限制和临时锁定
3. 添加"忘记 PIN"恢复机制
4. 支持多用户多 PIN
5. 添加 PIN 修改界面
6. 记录登录日志

## 截图说明

### 亮色主题
- PIN 对话框使用白色背景
- 输入框有蓝色聚焦边框
- 错误信息显示为红色

### 暗色主题
- PIN 对话框使用深色背景
- 保持良好的对比度
- 所有颜色自动适配暗色主题

## 故障排除

### 问题：PIN 对话框不显示

**可能原因：**
1. `pinEnabled` 未设置为 `true`
2. Cookie 仍然有效
3. JavaScript 错误

**解决方法：**
1. 检查 `config.json` 中的 `security.pinEnabled`
2. 清除浏览器 Cookie
3. 打开浏览器开发者工具查看控制台错误

### 问题：输入正确 PIN 后仍然提示错误

**可能原因：**
1. PIN 不匹配（注意大小写和空格）
2. 配置文件未正确保存
3. 服务器未重启

**解决方法：**
1. 确认 `config.json` 中的 PIN 值
2. 重启服务器
3. 检查服务器日志

### 问题：页面一直显示 PIN 对话框

**可能原因：**
1. Cookie 被阻止
2. 浏览器隐私设置过严格

**解决方法：**
1. 检查浏览器 Cookie 设置
2. 允许该网站设置 Cookie
3. 尝试使用无痕模式测试

## 总结

PIN 认证功能已完整实现，包括：

✅ 前端 UI 组件（对话框、输入框、错误提示）
✅ 后端 API 端点（`/api/pin`）
✅ 中间件集成（安全检查）
✅ 国际化支持（中英文）
✅ 主题适配（亮色/暗色）
✅ 响应式设计（PC/移动）
✅ Cookie 管理（7天有效期）
✅ 完整的用户体验（加载状态、错误处理、键盘支持）

该功能与现有设计语言完全一致，提供了流畅的用户体验。
