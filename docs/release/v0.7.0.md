# v0.7.0

## 核心变更 (Core Changes)

- **安全功能全面升级**：
  - 新增基于 IP 的黑/白名单访问控制机制
  - 新增 PIN 码认证功能，保护应用访问安全
  - 支持 CIDR 范围表示法（/8, /16, /24）
  - 实现配置文件热重载，无需重启即可应用配置更改

- **前端认证界面**：
  - 精心设计的 PIN 输入对话框，完全符合现有设计语言
  - 自动适配亮色/暗色主题
  - 支持中英文国际化
  - 流畅的交互体验和错误提示

## 新增功能 (Features)

### 安全认证

- **IP 白名单**：
  - 限制只有指定 IP 地址或 IP 范围可以访问
  - 支持单个 IP 地址（如 `192.168.1.100`）
  - 支持 CIDR 范围（如 `192.168.1.0/24`、`10.0.0.0/8`）
  - 为空时不进行限制

- **IP 黑名单**：
  - 阻止特定 IP 地址或 IP 范围访问
  - 支持单个 IP 和 CIDR 范围
  - 黑名单优先级高于白名单

- **PIN 认证**：
  - 可配置的 PIN 码保护（默认 `0000`）
  - 验证成功后自动设置 Cookie（7 天有效期）
  - 支持通过请求头 `X-PIN` 或 Cookie 传递
  - 精美的 PIN 输入界面，完全融入现有设计

### 配置热重载

- **自动监控配置文件**：
  - 每 2 秒检查配置文件修改
  - 检测到更改后自动重新加载
  - 无需重启服务器即可应用新配置
  - 记录详细的重载日志

### 前端界面

- **PIN 认证对话框**：
  - 居中显示，最大宽度 400px
  - 大字体输入框，字母间距增大便于查看
  - 实时错误提示（红色文字）
  - 加载状态显示（"验证中..."）
  - 支持 Enter 键提交
  - 自动聚焦输入框

- **国际化支持**：
  - 中文：身份验证、请输入 PIN 码、提交、PIN 码错误等
  - 英文：Authentication Required、Enter PIN、Submit、Incorrect PIN 等

## API 变更 (API Changes)

### 新增端点

- **`POST /api/pin`**：PIN 验证端点
  - 请求体：`{ "pin": "1234" }`
  - 响应：`{ "valid": true/false, "enabled": true/false }`
  - 验证成功后设置 `msp_pin` Cookie

### 中间件更新

- **安全中间件**：
  - 静态资源（HTML、CSS、JS）无需认证即可访问
  - 只有 API 端点（`/api/*`）需要 PIN 认证
  - `/api/pin` 端点本身不需要 PIN（避免循环）
  - IP 过滤在 PIN 验证之前执行

## 配置变更 (Configuration)

### 新增配置项

在 `config.json` 中新增 `security` 部分：

```json
{
  "security": {
    "ipWhitelist": [],
    "ipBlacklist": [],
    "pinEnabled": false,
    "pin": "0000"
  }
}
```

### 配置说明

- `ipWhitelist`：IP 白名单数组，支持单个 IP 和 CIDR 范围
- `ipBlacklist`：IP 黑名单数组，支持单个 IP 和 CIDR 范围
- `pinEnabled`：是否启用 PIN 认证（布尔值）
- `pin`：PIN 码字符串（默认 `"0000"`）

## 优化 (Optimizations)

- **智能 IP 识别**：
  - 自动从 `X-Forwarded-For` 头提取真实 IP
  - 支持 `X-Real-IP` 头
  - 正确处理 IPv6 地址
  - 适配反向代理环境

- **安全性增强**：
  - Cookie 设置为 HttpOnly（防止 XSS）
  - SameSite: Strict 模式
  - 7 天有效期，平衡安全性和便利性

- **性能优化**：
  - 配置文件监控使用独立 goroutine
  - 2 秒检查间隔，平衡响应速度和系统负载
  - 静态资源直接放行，减少中间件开销

## 修复 (Fixes)

- **中间件逻辑修复**：
  - 修复 PIN 认证导致静态资源无法加载的问题
  - 正确区分静态资源和 API 端点
  - 确保前端可以正常加载并显示 PIN 对话框

- **测试更新**：
  - 更新 `requiresPIN` 测试用例以匹配新逻辑
  - 新增静态资源访问测试
  - 新增 API 端点认证测试

## 文档 (Documentation)

### 新增文档

- **`docs/SECURITY.md`**：详细的安全配置指南
- **`docs/SECURITY_QUICKSTART.md`**：快速开始指南
- **`docs/SECURITY_UPDATE.md`**：安全功能更新说明
- **`docs/CONFIG_EXAMPLE.md`**：带注释的配置示例
- **`docs/PIN_TESTING.md`**：PIN 功能测试指南

### 更新文档

- **`CHANGELOG.md`**：添加 v0.7.0 更新日志
- **`config.example.json`**：添加 security 配置示例

## 使用示例 (Examples)

### 示例 1：仅允许本地网络访问

```json
{
  "security": {
    "ipWhitelist": ["127.0.0.1", "192.168.1.0/24"],
    "ipBlacklist": [],
    "pinEnabled": false,
    "pin": "0000"
  }
}
```

### 示例 2：启用 PIN 认证

```json
{
  "security": {
    "ipWhitelist": [],
    "ipBlacklist": [],
    "pinEnabled": true,
    "pin": "1999"
  }
}
```

### 示例 3：组合使用（推荐）

```json
{
  "security": {
    "ipWhitelist": ["192.168.1.0/24"],
    "ipBlacklist": ["192.168.1.100"],
    "pinEnabled": true,
    "pin": "8888"
  }
}
```

## 开发者 (Developers)

### 后端变更

- **`internal/config/config.go`**：
  - 新增 `SecurityConfig` 结构体
  - 更新 `Default()` 和 `ApplyDefaults()` 函数

- **`internal/handler/middleware.go`**：
  - 新增 `WithSecurity()` 中间件
  - 实现 IP 过滤和 PIN 认证逻辑
  - 新增 `requiresPIN()` 函数

- **`internal/handler/handlers.go`**：
  - 新增 `HandlePIN()` 处理函数

- **`internal/server/server.go`**：
  - 新增 `cfgModTime` 字段
  - 新增 `WatchConfig()` 方法实现热重载

- **`cmd/msp/main.go`**：
  - 集成安全中间件
  - 启动配置文件监控

### 前端变更

- **`web/index.html`**：
  - 新增 PIN 认证对话框 HTML 结构

- **`web/src/app.js`**：
  - 新增 PIN 验证相关函数
  - 新增国际化文本
  - 在 `boot()` 中集成 PIN 检查

### 测试变更

- **`internal/handler/middleware_test.go`**：
  - 新增 IP 过滤测试
  - 新增 CIDR 匹配测试
  - 新增 PIN 认证测试
  - 更新 `requiresPIN` 测试用例

## 升级指南 (Upgrade Guide)

### 从 v0.6.0 升级

1. **备份配置文件**：
   ```bash
   cp config.json config.json.backup
   ```

2. **更新可执行文件**：
   - 下载新版本
   - 替换旧的可执行文件

3. **配置文件会自动升级**：
   - 首次运行时会自动添加 `security` 配置
   - 默认不启用任何安全限制
   - 向后完全兼容

4. **可选：启用安全功能**：
   - 编辑 `config.json`
   - 设置 IP 白名单或启用 PIN
   - 保存文件（2 秒内自动生效）

## 注意事项 (Notes)

### 安全建议

- **开发环境**：可以不启用任何安全功能
- **局域网环境**：建议使用 IP 白名单
- **公网环境**：强烈建议同时启用 IP 白名单和 PIN 认证
- **定期更换 PIN**：建议定期更换 PIN 码

### 兼容性

- 所有更改向后兼容
- 默认配置不启用安全限制
- 现有功能和 API 不受影响
- 前端界面保持一致的设计语言

### 性能影响

- 配置热重载：每 2 秒检查一次文件，影响极小
- IP 过滤：字符串比较，性能开销可忽略
- PIN 认证：只对 API 端点生效，静态资源不受影响

## 已知限制 (Known Limitations)

1. **CIDR 支持**：当前仅支持 /8、/16、/24 范围
2. **PIN 重试限制**：暂无重试次数限制
3. **多用户支持**：当前仅支持单个 PIN
4. **密码强度**：无密码强度验证

## 后续计划 (Future Plans)

- 支持更多 CIDR 范围（/32、/0 等）
- 添加 PIN 重试次数限制
- 支持多用户多 PIN
- 添加 PIN 修改界面
- 支持更强的认证机制（如 OAuth）
- 记录访问日志和审计

## 贡献者 (Contributors)

感谢所有为本版本做出贡献的开发者！

---

**完整更新日志**: [CHANGELOG.md](../../CHANGELOG.md)  
**安全配置指南**: [docs/SECURITY.md](../SECURITY.md)  
**快速开始**: [docs/SECURITY_QUICKSTART.md](../SECURITY_QUICKSTART.md)
