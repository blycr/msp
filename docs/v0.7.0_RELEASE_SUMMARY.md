# MSP v0.7.0 发布总结

## 版本信息

- **版本号**：v0.7.0
- **发布日期**：2026-01-13
- **主要更新**：安全功能全面升级、配置热重载

## 核心功能

### 1. 安全功能

#### IP 访问控制
- ✅ IP 白名单机制
- ✅ IP 黑名单机制
- ✅ CIDR 范围支持（/8, /16, /24）
- ✅ 智能 IP 识别（支持代理环境）

#### PIN 认证
- ✅ 可配置的 PIN 码保护
- ✅ 精美的 PIN 输入界面
- ✅ 自动适配亮色/暗色主题
- ✅ 中英文国际化支持
- ✅ Cookie 自动保存（7天有效期）

### 2. 配置热重载

- ✅ 自动监控配置文件修改
- ✅ 2秒内自动重新加载
- ✅ 无需重启服务器
- ✅ 适用于所有配置项

## 技术实现

### 后端变更

| 文件 | 变更内容 |
|------|----------|
| `internal/config/config.go` | 新增 SecurityConfig 结构体 |
| `internal/handler/middleware.go` | 新增安全中间件和 IP 过滤逻辑 |
| `internal/handler/handlers.go` | 新增 HandlePIN 处理函数 |
| `internal/server/server.go` | 新增配置热重载功能 |
| `cmd/msp/main.go` | 集成安全中间件和配置监控 |

### 前端变更

| 文件 | 变更内容 |
|------|----------|
| `web/index.html` | 新增 PIN 认证对话框 |
| `web/src/app.js` | 新增 PIN 验证逻辑和国际化 |

### 测试覆盖

| 测试文件 | 测试内容 |
|----------|----------|
| `internal/handler/middleware_test.go` | IP 过滤、CIDR 匹配、PIN 认证测试 |

## 文档更新

### 新增文档

1. **`docs/release/v0.7.0.md`** - 版本发布文档
2. **`docs/SECURITY.md`** - 详细的安全配置指南
3. **`docs/SECURITY_QUICKSTART.md`** - 快速开始指南
4. **`docs/SECURITY_UPDATE.md`** - 安全功能更新说明
5. **`docs/CONFIG_EXAMPLE.md`** - 带注释的配置示例
6. **`docs/PIN_TESTING.md`** - PIN 功能测试指南

### 更新文档

1. **`CHANGELOG.md`** - 添加 v0.7.0 更新日志
2. **`config.example.json`** - 添加 security 配置示例
3. **`msp.wiki/Configuration_CN.md`** - 更新配置文档
4. **`msp.wiki/Changelog.md`** - 更新 Wiki 更新日志
5. **`msp.wiki/Security_CN.md`** - 新增安全功能专题页面
6. **`msp.wiki/_Sidebar.md`** - 添加安全功能链接

## 配置示例

### 基本配置

```json
{
  "security": {
    "ipWhitelist": [],
    "ipBlacklist": [],
    "pinEnabled": false,
    "pin": "0000"
  }
}
```

### 推荐配置（局域网）

```json
{
  "security": {
    "ipWhitelist": ["127.0.0.1", "192.168.1.0/24"],
    "ipBlacklist": [],
    "pinEnabled": false,
    "pin": "0000"
  }
}
```

### 推荐配置（公网）

```json
{
  "security": {
    "ipWhitelist": ["192.168.1.0/24"],
    "ipBlacklist": [],
    "pinEnabled": true,
    "pin": "your_secure_pin"
  }
}
```

## 使用建议

| 环境 | IP 白名单 | PIN 认证 |
|------|-----------|----------|
| 开发环境 | ❌ | ❌ |
| 家庭局域网 | ✅ | ⚠️ 可选 |
| 办公室网络 | ✅ | ✅ |
| 公网访问 | ✅ 必须 | ✅ 必须 |

## 测试结果

- ✅ 所有单元测试通过
- ✅ IP 过滤功能正常
- ✅ CIDR 匹配功能正常
- ✅ PIN 认证功能正常
- ✅ 配置热重载功能正常
- ✅ 前端界面显示正常
- ✅ 国际化功能正常
- ✅ 主题适配正常

## 已知限制

1. CIDR 支持：当前仅支持 /8、/16、/24 范围
2. PIN 重试限制：暂无重试次数限制
3. 多用户支持：当前仅支持单个 PIN

## 后续计划

- [ ] 支持更多 CIDR 范围
- [ ] 添加 PIN 重试次数限制
- [ ] 支持多用户多 PIN
- [ ] 添加 PIN 修改界面
- [ ] 支持 OAuth 等更强认证机制
- [ ] 记录访问日志和审计

## 升级指南

### 从 v0.6.0 升级

1. 备份配置文件：`cp config.json config.json.backup`
2. 下载并替换新版本可执行文件
3. 首次运行时配置文件会自动升级
4. 默认不启用安全功能，向后完全兼容

### 启用安全功能

1. 编辑 `config.json`
2. 配置 `security` 部分
3. 保存文件（2秒内自动生效）

## 问题排查

### 常见问题

1. **PIN 对话框不显示**
   - 检查 `pinEnabled` 是否为 `true`
   - 清除浏览器 Cookie
   - 查看浏览器控制台错误

2. **配置白名单后无法访问**
   - 确认您的 IP 在白名单中
   - 检查 CIDR 范围配置
   - 临时清空白名单测试

3. **配置修改不生效**
   - 等待 2 秒让配置重载
   - 查看服务器日志确认重载
   - 检查 JSON 格式是否正确

## 相关链接

- **GitHub 仓库**：https://github.com/blycr/msp
- **Wiki 文档**：https://github.com/blycr/msp/wiki
- **发布页面**：https://github.com/blycr/msp/releases/tag/v0.7.0
- **问题反馈**：https://github.com/blycr/msp/issues

## 贡献者

感谢所有为本版本做出贡献的开发者！

---

**发布日期**：2026-01-13  
**版本标签**：v0.7.0  
**构建状态**：✅ 通过
